<% layout('layouts/boilerplate') %>

<div class="container mt-5">
  <div class="row justify-content-center">
    <!-- Left Side: Campground Details -->
    <div class="col-md-6">
      <div class="card shadow">
        <% if (campground.image) { %>
          <img src="<%= campground.image %>" class="card-img-top img-fluid" alt="<%= campground.title %>" style="height: 250px; object-fit: cover;">
        <% } %>

        <div class="card-body">
          <h3 class="card-title text-center mb-3"><%= campground.title %></h3>
          <p class="card-text">
            üìç <strong>Location:</strong> <%= campground.location %><br>
            üí≤ <strong>Price:</strong> $<%= campground.price %>
          </p>
          <p class="card-text"><%= campground.description %></p>

          <% 
            // Robust owner check: works with populated or ObjectId
            const campOwnerId = campground.author && (campground.author._id || campground.author);
            const canManageCamp = currentUser && campOwnerId && String(campOwnerId) === String(currentUser._id);
          %>

          <% if (canManageCamp) { %>
            <a href="/campgrounds/<%= campground._id %>/edit" class="btn btn-secondary w-100 mb-2">Edit</a>
            <form action="/campgrounds/<%= campground._id %>?_method=DELETE" method="POST">
              <button type="submit" class="btn btn-danger w-100">Delete</button>
            </form>
          <% } %>

          <a href="/campgrounds" class="btn btn-outline-primary mt-3 w-100">‚¨Ö Back</a>
        </div>
      </div>
    </div>

    <!-- Right Side: Ratings & Reviews -->
    <div class="col-md-5">
      <!-- Review Submission -->
      <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
          <strong>Leave a Review</strong>
        </div>
        <div class="card-body">
          <% if (currentUser) { %>
            <form action="/campgrounds/<%= campground._id %>/reviews" method="POST">
              <div class="mb-3">
                <label for="rating" class="form-label">Rating</label>
                <input type="range" name="review[rating]" id="rating" class="form-range" min="1" max="5" step="1" value="3" required>
              </div>
              <div class="mb-3">
                <label for="body" class="form-label">Review</label>
                <textarea name="review[body]" id="body" class="form-control" rows="3" placeholder="Write your review here..." required></textarea>
              </div>
              <button type="submit" class="btn btn-primary w-100">Submit Review</button>
            </form>
          <% } else { %>
            <p class="mb-0">You must <a href="/login">log in</a> to leave a review.</p>
          <% } %>
        </div>
      </div>

      <!-- Review List -->
      <div class="card shadow">
        <div class="card-header bg-secondary text-white">
          <strong>All Reviews</strong>
        </div>
        <ul class="list-group list-group-flush">
          <% if (campground.reviews.length > 0) { %>
            <% campground.reviews.forEach(review => { 
                 const reviewAuthorId = review.author && (review.author._id || review.author);
                 const canDeleteReview = currentUser && reviewAuthorId && String(reviewAuthorId) === String(currentUser._id);
            %>
              <li class="list-group-item d-flex justify-content-between align-items-start">
                <div class="me-2">
                  <strong>‚≠ê <%= review.rating %>/5</strong><br>
                  <%= review.body %>
                  <% if (review.author && review.author.username) { %>
                    <div class="text-muted small mt-1">by <%= review.author.username %></div>
                  <% } %>
                </div>

                <% if (canDeleteReview) { %>
                  <form action="/campgrounds/<%= campground._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST" class="ms-2">
                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete your review">‚úï</button>
                  </form>
                <% } %>
              </li>
            <% }); %>
          <% } else { %>
            <li class="list-group-item text-muted text-center">No reviews yet.</li>
          <% } %>
        </ul>
      </div>
    </div>
  </div>
</div>
